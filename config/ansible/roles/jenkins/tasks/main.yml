- name: Ensure Jenkins namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ devsecops_namespace_ci }}"
        labels:
          pod-security.kubernetes.io/enforce: baseline
  kubeconfig: "{{ kubeconfig_path }}"
  tags: ["jenkins"]

- name: Build Docker config payload for Jenkins
  ansible.builtin.set_fact:
    jenkins_registry_auth: >-
      {{
        {
          "auths": {
            (registry_hostname): {
              "username": registry_username,
              "password": registry_password,
              "auth": (registry_username + ":" + registry_password) | b64encode
            }
          }
        }
      }}
  tags: ["jenkins"]

- name: Create Docker registry secret for Jenkins agents
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: registry-credentials
        namespace: "{{ devsecops_namespace_ci }}"
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: >-
          {{ jenkins_registry_auth | to_nice_json | b64encode }}
  kubeconfig: "{{ kubeconfig_path }}"
  tags: ["jenkins"]

- name: Add Jenkins Helm repository
  kubernetes.core.helm_repository:
    name: jenkins
    repo_url: https://charts.jenkins.io
  environment: "{{ helm_environment | default({}) }}"
  tags: ["jenkins"]

- name: Deploy Jenkins controller
  kubernetes.core.helm:
    name: "{{ jenkins_release_name }}"
    chart_ref: jenkins/jenkins
    release_namespace: "{{ devsecops_namespace_ci }}"
    create_namespace: false
    kubeconfig: "{{ kubeconfig_path }}"
    values: "{{ lookup('template', 'values.yaml.j2') | from_yaml }}"
    wait: true
    timeout: 600
    update_repo_cache: true
    version: "{{ jenkins_chart_version | default(omit) }}"
  environment: "{{ helm_environment | default({}) }}"
  tags: ["jenkins"]

